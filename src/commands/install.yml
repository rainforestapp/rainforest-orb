description: Install the Rainforest QA CLI
parameters:
  install_path:
    description: Where to install the CLI.
    type: string
    default: /usr/local/bin
  channel:
    description: "[DEPRECATED] This parameter no longer has any effect and will be removed in a future version"
    type: string
    default: ""
  version:
    description: Which (v-prefixed) version of the CLI to install. Defaults to the latest.
    type: string
    default: ""
  platform:
    description: Which platform to install the CLI for.
    type: enum
    enum: ["darwin", "linux"]
    default: linux
  architecture:
    description: 386 (32-bit) or amd64 (64-bit).
    type: enum
    enum: ["386", "amd64"]
    default: amd64
  github_token:
    description: Name of the environment variable holding a GitHub token, used to avoid API rate limits when fetching the CLI release.
    type: env_var_name
    default: GITHUB_TOKEN
steps:
  - run:
      name: Warn about deprecations
      command: |
        if [ -n "<< parameters.channel >>" ]; then
          echo "The 'channel' parameter is deprecated, please remove it from your configuration."
          echo "If you'd like to use a specific version, use the new 'version' parameter instead."
          echo "See https://github.com/rainforestapp/rainforest-orb/releases/tag/v3.0.1 for more info."
          exit 1
        fi
  - run:
      name: Download and set up executable
      command: |
        release_url=https://api.github.com/repos/rainforestapp/rainforest-cli/releases
        if [ -n "<< parameters.version >>" ]; then
          release_url="$release_url/tags/<< parameters.version >>"
        else
          release_url="$release_url/latest"
        fi
        echo $release_url

        # Pass a GitHub token if available to avoid unauthenticated rate limits
        # (60 req/hr). Without a token, the API may return a rate-limit error
        # with no .assets field, causing jq to fail and the install to silently
        # succeed with an empty asset_url. -f makes curl exit non-zero on HTTP
        # errors so the step fails loudly instead.
        if [ -n "${<< parameters.github_token >>}" ]; then
          api_response=$(curl -f -H "Authorization: token ${<< parameters.github_token >>}" "$release_url")
        else
          api_response=$(curl -f "$release_url")
        fi

        asset_url=$(echo "$api_response" | jq -r '.assets[].browser_download_url' | grep << parameters.platform >>-<< parameters.architecture >>)

        wget $asset_url -O rainforest-cli.tgz
        tar xvf rainforest-cli.tgz -C << parameters.install_path >>
